<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªå‹•ç”Ÿæˆ</title>
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container {
            max-width: 1024px;
        }
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800">ğŸ¸ãƒ©ã‚¤ãƒ–ãƒã‚¦ã‚¹ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼ğŸ™ï¸</h1>
            <p class="mt-2 text-gray-600">åŸºæœ¬çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã€RHãƒ»æœ¬ç•ªã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
        </header>

        <main class="grid grid-cols-1 lg:col-span-3 gap-8">
            <!-- è¨­å®šå…¥åŠ›ã‚¨ãƒªã‚¢ (1/3 or full) -->
            <div class="lg:col-span-1" id="settings-container">
                <div class="bg-white p-6 rounded-xl shadow-custom sticky top-8">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-700">ğŸ—“ï¸ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h2>
                    <form id="settings-form" onchange="calculateSchedule()">

                        <!-- ã‚¤ãƒ™ãƒ³ãƒˆåŸºæœ¬æƒ…å ± -->
                        <fieldset class="mb-6 p-4 border border-gray-200 rounded-lg">
                            <legend class="text-sm font-semibold px-2 text-gray-700">åŸºæœ¬æ™‚é–“è¨­å®š</legend>
                            <div class="space-y-4">
                                <div>
                                    <label for="openTime" class="block text-sm font-medium text-gray-700">ã‚ªãƒ¼ãƒ—ãƒ³æ™‚é–“</label>
                                    <input type="time" id="openTime" value="18:00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="startTime" class="block text-sm font-medium text-gray-700">ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“</label>
                                    <input type="time" id="startTime" value="18:30" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                        </fieldset>

                        <!-- å‡ºæ¼”ãƒãƒ³ãƒ‰æƒ…å ± -->
                        <fieldset class="mb-6 p-4 border border-gray-200 rounded-lg">
                            <legend class="text-sm font-semibold px-2 text-gray-700">ãƒãƒ³ãƒ‰æƒ…å ±ãƒ»æ™‚é–“é…åˆ†</legend>
                            <div class="space-y-4">
                                <div>
                                    <label for="bandCount" class="block text-sm font-medium text-gray-700">ãƒãƒ³ãƒ‰æ•° (1ã€œ10çµ„)</label>
                                    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’5ã«å¤‰æ›´ -->
                                    <input type="number" id="bandCount" value="5" min="1" max="10" 
                                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                           oninput="handleBandCountChange()">
                                </div>
                                <div>
                                    <label for="playTimeMin" class="block text-sm font-medium text-gray-700">å„ãƒãƒ³ãƒ‰ã®æ¼”å¥æ™‚é–“ (åˆ†)</label>
                                    <input type="number" id="playTimeMin" value="30" min="10" step="5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="changeoverTimeMin" class="block text-sm font-medium text-gray-700">å„ãƒãƒ³ãƒ‰ã®è»¢æ›æ™‚é–“ (åˆ†)</label>
                                    <input type="number" id="changeoverTimeMin" value="15" min="5" step="5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                        </fieldset>
                        
                        <!-- ãƒãƒ³ãƒ‰åå€‹åˆ¥è¨­å®šã‚’è¿½åŠ  -->
                        <fieldset class="mb-6 p-4 border border-gray-200 rounded-lg">
                            <legend class="text-sm font-semibold px-2 text-gray-700">ãƒãƒ³ãƒ‰åè¨­å®š (å‡ºæ¼”é †)</legend>
                            <div id="band-names-container" class="space-y-3">
                                <!-- JSã§ãƒãƒ³ãƒ‰åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ã«æŒ¿å…¥ -->
                            </div>
                        </fieldset>

                        <!-- ãƒªãƒãƒ¼ã‚µãƒ«æ–¹å¼ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®š -->
                        <fieldset class="mb-6 p-4 border border-gray-200 rounded-lg">
                            <legend class="text-sm font-semibold px-2 text-gray-700">ãƒªãƒãƒ¼ã‚µãƒ«è¨­å®š</legend>
                            <div class="space-y-4">
                                <div>
                                    <label for="rehearsalType" class="block text-sm font-medium text-gray-700">ãƒªãƒãƒ¼ã‚µãƒ«æ–¹å¼</label>
                                    <select id="rehearsalType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <!-- é †åºã¨è¡¨è¨˜ã‚’ä¿®æ­£ -->
                                        <option value="noRehearsal">ãƒªãƒç„¡ã—</option>
                                        <option value="normalRehearsal">é †ãƒªãƒ</option>
                                        <option value="prepRehearsal">é€†ãƒªãƒ</option>
                                    </select>
                                </div>
                                
                                <!-- ãƒªãƒãƒ¼ã‚µãƒ«æ™‚é–“ -->
                                <div>
                                    <label for="rehearsalTimeMin" class="block text-sm font-medium text-gray-700">å„ãƒãƒ³ãƒ‰ã®RHæ™‚é–“ (åˆ†) <span class="text-xs text-gray-500">(è»¢æ›è¾¼ã¿ã®å æœ‰æ™‚é–“)</span></label>
                                    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’30åˆ†ã«å¤‰æ›´ -->
                                    <input type="number" id="rehearsalTimeMin" value="30" min="10" step="5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>

                                <div id="interval-setting">
                                    <label for="intervalBeforeOpenMin" class="block text-sm font-medium text-gray-700">RHçµ‚äº†ã‹ã‚‰ã‚ªãƒ¼ãƒ—ãƒ³ã¾ã§ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ« (åˆ†)</label>
                                    <input type="number" id="intervalBeforeOpenMin" value="30" min="0" step="5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                
                                <!-- è»¢æ›éè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                                <div class="pt-2 border-t border-gray-200 mt-4">
                                    <label class="flex items-center text-sm font-medium text-gray-700">
                                        <input type="checkbox" id="hideChangeover" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500 mr-2" onchange="calculateSchedule()">
                                        æœ¬ç•ªã®è»¢æ›é …ç›®ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                                    </label>
                                </div>

                                <p id="no-reha-message" class="text-red-500 text-sm hidden">â€»ã€Œãƒªãƒç„¡ã—ã€é¸æŠæ™‚ã€RHæ™‚é–“ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚</p>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>

            <!-- ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«å‡ºåŠ›ã‚¨ãƒªã‚¢ (2/3 or full) -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-custom">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-green-700">ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«</h2>

                    <div class="flex justify-end mb-4 space-x-2" id="action-buttons">
                        <button onclick="copyTimetable()" class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    
                    <div id="timetable-output" class="space-y-6">
                        <!-- ã“ã“ã«ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        <div class="text-center p-8 bg-gray-50 rounded-lg text-gray-500">
                            è¨­å®šã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                        </div>
                    </div>

                    <div id="copy-success-message" class="mt-4 p-3 bg-green-100 text-green-700 rounded-lg hidden">
                        ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- ã‚¿ã‚¤ãƒ å‡¦ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        /**
         * "HH:MM" å½¢å¼ã®æ™‚åˆ»æ–‡å­—åˆ—ã‚’ã€ãã®æ—¥ã®åˆå‰0æ™‚ã‹ã‚‰ã®ç·åˆ†æ•°ã«å¤‰æ›ã—ã¾ã™ã€‚
         */
        function timeToMinutes(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length !== 2) return null;
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            if (isNaN(hours) || isNaN(minutes)) return null;
            return hours * 60 + minutes;
        }

        /**
         * ç·åˆ†æ•°ã‚’ "HH:MM" å½¢å¼ã®æ™‚åˆ»æ–‡å­—åˆ—ã«å¤‰æ›ã—ã€24:00ä»¥é™ã‚‚ç¶™ç¶šã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function minutesToContinuousTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        
        /**
         * ãƒãƒ³ãƒ‰åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã—ã€å€¤ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚
         * @param {number} count - ãƒãƒ³ãƒ‰æ•°
         */
        function updateBandNameInputs(count) {
            const container = document.getElementById('band-names-container');
            let html = '';
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¼•ã£ã‹ã‹ã‚‹å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (count < 1 || count > 10) return;

            for (let i = 1; i <= count; i++) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ—¢å­˜ã®å€¤ã‚’å–å¾—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š
                const defaultBandName = `Band ${i}`;
                const currentName = localStorage.getItem(`bandName_${i}`) || defaultBandName;

                html += `
                    <div>
                        <label for="bandName_${i}" class="block text-xs font-medium text-gray-500">å‡ºæ¼”é † ${i}.</label>
                        <input type="text" id="bandName_${i}" value="${currentName}" placeholder="${defaultBandName}" 
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                               oninput="saveBandName(${i}, this.value)" onchange="saveBandName(${i}, this.value)">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        /**
         * ãƒãƒ³ãƒ‰åãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚
         */
        function saveBandName(index, name) {
            localStorage.setItem(`bandName_${index}`, name);
            calculateSchedule();
        }

        /**
         * ãƒãƒ³ãƒ‰æ•°ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°ã—ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚
         */
        function handleBandCountChange() {
            const bandCount = parseInt(document.getElementById('bandCount').value, 10);
            updateBandNameInputs(bandCount);
            calculateSchedule();
        }

        // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * UIã‹ã‚‰è¨­å®šå€¤ã‚’èª­ã¿å–ã£ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨ˆç®—ã—ã€è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function calculateSchedule() {
            const openTimeStr = document.getElementById('openTime').value;
            const startTimeStr = document.getElementById('startTime').value;
            const bandCount = parseInt(document.getElementById('bandCount').value, 10);
            const playTimeMin = parseInt(document.getElementById('playTimeMin').value, 10);
            const changeoverTimeMin = parseInt(document.getElementById('changeoverTimeMin').value, 10);
            const rehearsalType = document.getElementById('rehearsalType').value;
            const rehearsalTimeMin = parseInt(document.getElementById('rehearsalTimeMin').value, 10);
            const intervalBeforeOpenMin = parseInt(document.getElementById('intervalBeforeOpenMin').value, 10);
            const hideChangeover = document.getElementById('hideChangeover').checked; // è»¢æ›éè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³

            // ãƒªãƒç„¡ã—ã®å ´åˆã®UIåˆ¶å¾¡
            const isNoRehearsal = rehearsalType === 'noRehearsal';
            
            // ãƒªãƒé–¢é€£ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶å¾¡
            const intervalSetting = document.getElementById('interval-setting');
            const rehearsalTimeInput = document.getElementById('rehearsalTimeMin');

            intervalSetting.classList.toggle('opacity-50', isNoRehearsal);
            document.getElementById('intervalBeforeOpenMin').disabled = isNoRehearsal;
            rehearsalTimeInput.disabled = isNoRehearsal; // RHæ™‚é–“ã‚‚ç„¡åŠ¹åŒ–
            document.getElementById('no-reha-message').classList.toggle('hidden', !isNoRehearsal);

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            if (bandCount < 1 || bandCount > 10 || playTimeMin < 5 || changeoverTimeMin < 0 || (!isNoRehearsal && rehearsalTimeMin < 5)) {
                document.getElementById('timetable-output').innerHTML = `
                    <p class="text-red-500 p-4 bg-red-50 rounded-lg">å…¥åŠ›å€¤ãŒä¸æ­£ã§ã™ã€‚ãƒãƒ³ãƒ‰æ•°ã¯1ã€œ10ã€æ¼”å¥æ™‚é–“ãƒ»RHæ™‚é–“ã¯5åˆ†ä»¥ä¸Šã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                `;
                return;
            }

            const outputDiv = document.getElementById('timetable-output');
            let outputHTML = '';
            let outputText = ''; // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆ

            // ãƒãƒ³ãƒ‰åã®ãƒªã‚¹ãƒˆå–å¾— (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå€¤ã‚’ä½¿ç”¨)
            const bands = [];
            for (let i = 1; i <= bandCount; i++) {
                const input = document.getElementById(`bandName_${i}`);
                let bandName = input ? input.value.trim() : `Band ${i}`;
                if (bandName === '') bandName = `Band ${i}`;
                bands.push(bandName); 
            }

            // --- 1. æœ¬ç•ª (Main Set) ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨ˆç®— ---

            const startTimeMin = timeToMinutes(startTimeStr);
            let currentTimeMin = startTimeMin;
            const mainSchedule = [];

            // æœ¬ç•ªã®è¨ˆç®—
            bands.forEach((band, index) => {
                const setStart = currentTimeMin;
                const setEnd = currentTimeMin + playTimeMin;

                mainSchedule.push({
                    type: 'performance',
                    band: band,
                    start: setStart,
                    end: setEnd,
                });
                currentTimeMin = setEnd; // æ¼”å¥çµ‚äº†

                // æœ€å¾Œã®ãƒãƒ³ãƒ‰ã§ãªã‘ã‚Œã°è»¢æ›æ™‚é–“ã‚’åŠ ãˆã‚‹
                if (index < bandCount - 1) {
                    const changeStart = currentTimeMin;
                    const changeEnd = currentTimeMin + changeoverTimeMin;
                    mainSchedule.push({
                        type: 'changeover',
                        start: changeStart,
                        end: changeEnd,
                    });
                    currentTimeMin = changeEnd; // è»¢æ›çµ‚äº† = æ¬¡ã®ãƒãƒ³ãƒ‰é–‹å§‹
                }
            });

            const eventEndTime = currentTimeMin; // ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†äºˆå®šæ™‚åˆ»ã¯è¨ˆç®—ã™ã‚‹ãŒã€å‡ºåŠ›ã¯ã—ãªã„

            // --- 2. ãƒªãƒãƒ¼ã‚µãƒ« (Rehearsal) ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨ˆç®— ---
            let rehearsalSchedule = [];
            let rehearsalStartTime = null;

            if (!isNoRehearsal) {
                const openTimeMin = timeToMinutes(openTimeStr);
                
                // RHçµ‚äº†æ™‚åˆ»: ã‚ªãƒ¼ãƒ—ãƒ³æ™‚é–“ - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                let rehaEndMin = openTimeMin - intervalBeforeOpenMin;
                
                // RHé †ã®æ±ºå®š
                let rehaBands = [...bands];
                if (rehearsalType === 'prepRehearsal') {
                    // é€†ãƒªãƒ: å‡ºæ¼”é †ã®é€†é † (N, N-1, ..., 1)
                    rehaBands.reverse();
                } else if (rehearsalType === 'normalRehearsal') {
                    // é †ãƒªãƒ: (2, 3, ..., N, 1) ã®é †ã«ã™ã‚‹ãŸã‚ã€1ç•ªç›®ã‚’æœ€å¾Œã«ç§»å‹•
                    if (rehaBands.length > 1) {
                         const firstBand = rehaBands.shift(); // 1ç•ªç›®ã‚’å–ã‚Šå‡ºã™
                         rehaBands.push(firstBand); // æœ€å¾Œã«åŠ ãˆã‚‹
                    }
                }

                let currentRehaTime = rehaEndMin;
                
                // RHã¯é€†é †ã«è¨ˆç®—ã—ã¦ã„ã (RHé †ã®æœ€å¾Œã®ãƒãƒ³ãƒ‰ã®RHã‹ã‚‰)
                for (let i = rehaBands.length - 1; i >= 0; i--) {
                    const band = rehaBands[i];
                    
                    // 1. RHæœ¬ä½“ã®è¨ˆç®—: è»¢æ›è¾¼ã¿ã®å æœ‰æ™‚é–“ã¨ã—ã¦ã€rehearsalTimeMinã®å¹…ã§å‰²ã‚Šå½“ã¦ã‚‹
                    const rehaEnd = currentRehaTime;
                    const rehaStart = currentRehaTime - rehearsalTimeMin; 
                    
                    rehearsalSchedule.unshift({ // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
                        type: 'rehearsal',
                        band: band,
                        start: rehaStart,
                        end: rehaEnd,
                    });
                    currentRehaTime = rehaStart; 
                }
                rehearsalStartTime = currentRehaTime;
            }


            // --- 3. HTMLã¨ãƒ†ã‚­ã‚¹ãƒˆã®ç”Ÿæˆ ---

            // **ãƒªãƒãƒ¼ã‚µãƒ«éƒ¨åˆ†ã®å‡ºåŠ›**
            if (!isNoRehearsal) {
                const openTimeMin = timeToMinutes(openTimeStr);
                const rehaEndMin = openTimeMin - intervalBeforeOpenMin;

                rehearsalSchedule.forEach(item => {
                    if (item.type === 'rehearsal') {
                        // RHæœ¬ä½“
                        outputHTML += renderTimelineItem(`${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}`, `${item.band} RH`, 'border-l-4 border-indigo-400 pl-4');
                        outputText += `${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}ã€€${item.band} RH (è»¢æ›è¾¼ã¿ ${rehearsalTimeMin}åˆ†)\n`;
                    } 
                });

                // ä¼šå ´æº–å‚™ (RHçµ‚äº†æ™‚åˆ» == ä¼šå ´æº–å‚™é–‹å§‹æ™‚åˆ»)
                outputHTML += renderTimelineItem(`${minutesToContinuousTime(rehaEndMin)}-${openTimeStr}`, `ä¼šå ´æº–å‚™`, 'bg-yellow-100 text-yellow-800 font-medium');
                outputText += `${minutesToContinuousTime(rehaEndMin)}-${openTimeStr}ã€€ä¼šå ´æº–å‚™ (${intervalBeforeOpenMin}åˆ†)\n`;

                // outputTextã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š
                outputText += '\n'; 
            }


            // **æœ¬ç•ªéƒ¨åˆ†ã®å‡ºåŠ›**

            // ã‚ªãƒ¼ãƒ—ãƒ³æ™‚é–“ - æ‹¬å¼§ã‚’å‰Šé™¤
            outputHTML += renderTimelineItem(openTimeStr, 'OPEN', 'bg-green-100 border-l-4 border-green-500 pl-4');
            // ä¿®æ­£: ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
            outputText += `${openTimeStr}ã€€OPEN\n`;

            // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ - æ‹¬å¼§ã‚’å‰Šé™¤
            outputHTML += renderTimelineItem(startTimeStr, 'START', 'bg-green-100 border-l-4 border-green-500 pl-4');
            // ä¿®æ­£: ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
            outputText += `${startTimeStr}ã€€START\n`;

            mainSchedule.forEach(item => {
                if (item.type === 'performance') {
                    // æ¼”å¥é …ç›®
                    outputHTML += renderTimelineItem(`${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}`, `${item.band}`, 'border-l-4 border-green-400 pl-4');
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼: åˆ†æ•°è¡¨è¨˜ã‚’è¿½åŠ 
                    outputText += `${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}ã€€${item.band} (${playTimeMin}åˆ†)\n`; 
                } else if (item.type === 'changeover') {
                    // è»¢æ›éè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒOFFã®å ´åˆã®ã¿è¡¨ç¤º
                    if (!hideChangeover) { 
                        // HTMLè¡¨ç¤º: ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¤º
                        outputHTML += renderTimelineItem(`${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}`, `è»¢æ›`, 'text-gray-500');
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼: åˆ†æ•°è¡¨è¨˜ã‚’è¿½åŠ 
                        outputText += `${minutesToContinuousTime(item.start)}-${minutesToContinuousTime(item.end)}ã€€è»¢æ› (${changeoverTimeMin}åˆ†)\n`; 
                    }
                }
            });

            // UIã®æ›´æ–°
            outputDiv.innerHTML = outputHTML;
            document.getElementById('timetable-output').setAttribute('data-copy-text', outputText);
        }

        /**
         * ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®é …ç›®ã‚’HTMLã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderTimelineItem(time, content, extraClasses = '') {
            // å¹…ã‚’ w-32 (128px) / sm:w-40 (160px) ã«æ‹¡å¼µã—ã€æ™‚é–“ã¨å†…å®¹ã®é–“ã«ã‚†ã¨ã‚Šã‚’æŒãŸã›ã¾ã—ãŸã€‚
            // items-center ã«å¤‰æ›´ã—ã€è¡Œã®å‚ç›´æ–¹å‘ã®ä¸­å¿ƒã‚’æƒãˆã¾ã™ã€‚
            return `
                <div class="flex items-center py-2 border-b border-gray-100 hover:bg-gray-50 transition ${extraClasses}">
                    <div class="w-32 sm:w-40 flex-shrink-0 text-lg font-mono text-gray-900 whitespace-nowrap">${time}</div>
                    <div class="flex-grow text-gray-700">${content}</div>
                </div>
            `;
        }
        
        /**
         * ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’HTMLã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
         */
        function renderSectionHeader(title, colorClass) {
            return `
                <div class="mt-6 mb-3 p-2 bg-gray-100 rounded-lg shadow-sm">
                    <h3 class="text-lg font-bold ${colorClass}">${title}</h3>
                </div>
            `;
        }


        /**
         * ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
         */
        function copyTimetable() {
            const textToCopy = document.getElementById('timetable-output').getAttribute('data-copy-text');

            if (!textToCopy) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º (alert() ã¯ä½¿ãˆãªã„ãŸã‚ã€UIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨)
                const outputDiv = document.getElementById('timetable-output');
                outputDiv.innerHTML = `
                    <p class="text-red-500 p-4 bg-red-50 rounded-lg">ã‚³ãƒ”ãƒ¼å¯¾è±¡ã®ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                `;
                console.error("ã‚³ãƒ”ãƒ¼å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            // navigator.clipboard.writeTextãŒä½¿ç”¨ã§ããªã„ç’°å¢ƒã‚’è€ƒæ…®ã—ã€execCommand('copy')ã‚’ä½¿ç”¨
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                const message = document.getElementById('copy-success-message');
                message.classList.remove('hidden');
                setTimeout(() => message.classList.add('hidden'), 3000);
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const outputDiv = document.getElementById('timetable-output');
                outputDiv.innerHTML = `
                    <p class="text-red-500 p-4 bg-red-50 rounded-lg">ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                `;
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆå›è¨ˆç®—ã‚’å®Ÿè¡Œ
        window.onload = () => {
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒãƒ³ãƒ‰æ•°ã«åŸºã¥ã„ã¦å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
            const initialBandCount = parseInt(document.getElementById('bandCount').value, 10);
            updateBandNameInputs(initialBandCount);
            // ãã®å¾Œã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨ˆç®—
            calculateSchedule();
        };
    </script>
</body>
</html>
